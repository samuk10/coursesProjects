name: Update README

on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT }}
    
    - name: Set up Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Pull changes
      run: git pull origin main --rebase

    - name: Fetch all branches
      run: git fetch --all

    - name: Get list of branches
      id: get_branches
      run: |
        branches=$(git branch -r | grep -v '\->' | grep -v 'main' | awk -F/ '{print $2}' | grep -v 'branch-base')
        branches=$(echo $branches | tr ' ' '\n' | sort -u | tr '\n' ' ')
        echo "branches=$branches" >> $GITHUB_ENV
        echo "::set-output name=branches::$branches"

    - name: Update README.md
      run: |
          git pull origin main
          echo "# RepositÃ³rio de Projetos de Cursos" > README.md
          echo "" >> README.md
          echo "Bem-vindo ao repositÃ³rio de Projetos de Cursos! Este repositÃ³rio foi criado para armazenar todas os projetos de Cursos que eu desenvolver como forma de estudo. Cada Projeto estarÃ¡ em uma branch separada, e vocÃª encontrarÃ¡ versÃµes diferentes do mesmo Projeto utilizando tecnologias distintas." >> README.md
          echo "" >> README.md
          echo "## Ãndice de Projetos de Cursos" >> README.md
          echo "" >> README.md
          for branch in ${{ steps.get_branches.outputs.branches }}; do
            echo "- [$branch](https://github.com/samuk10/coursesProjects/tree/$branch)" >> README.md
          done
          echo "" >> README.md
          echo "## Como Navegar no RepositÃ³rio" >> README.md
          echo "" >> README.md
          echo "1. **Branches:** Cada Projeto tem sua prÃ³pria branch principal. Navegue entre as branches para ver os diferentes projetos." >> README.md
          echo "2. **VersÃµes:** Dentro de cada branch, vocÃª encontrarÃ¡ diferentes versÃµes da Projeto, cada uma utilizando uma tecnologia diferente." >> README.md
          echo "## How-To" >> README.md
          echo "" >> README.md >> README.md
          echo "- Clonar repo" >> README.md
          echo "- Criar nova branch" >> README.md
          echo "- Quando fizer o push serÃ¡ criado um novo Ãndice" >> README.md
          echo "## ContribuiÃ§Ãµes" >> README.md
          echo "" >> README.md
          echo "Ideia do Workflow: [Kadu](https://www.tabnews.com.br/Kadu/automatizacao-inteligente-no-github-mantendo-seu-readme-sempre-atualizado)" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "Enjoy! ðŸ˜Š" >> README.md
    
    - name: Commit changes
      run: |
        git add README.md
        git diff-index --quiet HEAD || git commit -m 'Update README.md with branch links'
        git push origin main

    - name: Debugging
      run: |
        echo "Branches: ${{ steps.get_branches.outputs.branches }}"
        cat README.md